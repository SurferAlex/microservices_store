name: CI Pipeline

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# –ó–∞–¥–∞—á–∏ (jobs)
jobs:
  # –ó–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  check:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
      
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è auth_service
        working-directory: ./auth_service
        run: |
          echo "üìù –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ auth_service..."
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: gofmt -s -w ."
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è profile_service
        working-directory: ./profile_service
        run: |
          echo "üìù –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ profile_service..."
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: gofmt -s -w ."
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
      
      - name: üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ auth_service
        working-directory: ./auth_service
        run: |
          echo "üîé –ó–∞–ø—É—Å–∫–∞—é go vet –¥–ª—è auth_service..."
          go vet ./...
          echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–π–¥–µ–Ω!"
      
      - name: üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ profile_service
        working-directory: ./profile_service
        run: |
          echo "üîé –ó–∞–ø—É—Å–∫–∞—é go vet –¥–ª—è profile_service..."
          go vet ./...
          echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–π–¥–µ–Ω!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π auth_service
        working-directory: ./auth_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é go.mod –∏ go.sum –¥–ª—è auth_service..."
          go mod tidy
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå go.mod –∏–ª–∏ go.sum —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: go mod tidy"
            git status
            exit 1
          fi
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π profile_service
        working-directory: ./profile_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é go.mod –∏ go.sum –¥–ª—è profile_service..."
          go mod tidy
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå go.mod –∏–ª–∏ go.sum —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: go mod tidy"
            git status
            exit 1
          fi
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ auth_service
        working-directory: ./auth_service
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é auth_service..."
          go mod download
          go build ./cmd/main.go
          echo "‚úÖ auth_service –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ profile_service
        working-directory: ./profile_service
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é profile_service..."
          go mod download
          go build ./cmd/main.go
          echo "‚úÖ profile_service –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ!"
      
      - name: ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        run: |
          echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

  # –ó–∞–¥–∞—á–∞: —Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
  build:
    name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
    runs-on: ubuntu-latest
    needs: check  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
    
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
      
      - name: üê≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ auth_service
        uses: docker/build-push-action@v5
        with:
          context: ./auth_service
          file: ./auth_service/Dockerfile
          push: false
          tags: auth_service:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ profile_service
        uses: docker/build-push-action@v5
        with:
          context: ./profile_service
          file: ./profile_service/Dockerfile
          push: false
          tags: profile_service:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ‚úÖ –û–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã
        run: |
          echo "üéâ –í—Å–µ Docker –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!"

  # –ó–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
  migrations:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
      
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ golang-migrate
        run: |
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é golang-migrate..."
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate
          migrate -version
          echo "‚úÖ golang-migrate —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π auth_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∏–≥—Ä–∞—Ü–∏–π auth_service..."
          cd auth_service/migrations
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç –ø–∞—Ä—ã up/down
          for file in *.up.sql; do
            base="${file%.up.sql}"
            if [ ! -f "${base}.down.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ down-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–∞—Ä–∞: ${base}.up.sql –∏ ${base}.down.sql"
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ down-–º–∏–≥—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç up-–ø–∞—Ä—É
          for file in *.down.sql; do
            base="${file%.down.sql}"
            if [ ! -f "${base}.up.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ up-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
          done
          
          echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ auth_service –∏–º–µ—é—Ç –ø–∞—Ä—ã up/down"
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π profile_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∏–≥—Ä–∞—Ü–∏–π profile_service..."
          cd profile_service/migrations
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç –ø–∞—Ä—ã up/down
          for file in *.up.sql; do
            base="${file%.up.sql}"
            if [ ! -f "${base}.down.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ down-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–∞—Ä–∞: ${base}.up.sql –∏ ${base}.down.sql"
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ down-–º–∏–≥—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç up-–ø–∞—Ä—É
          for file in *.down.sql; do
            base="${file%.down.sql}"
            if [ ! -f "${base}.up.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ up-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
          done
          
          echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ profile_service –∏–º–µ—é—Ç –ø–∞—Ä—ã up/down"
      
      - name: üîç –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ SQL –º–∏–≥—Ä–∞—Ü–∏–π
        run: |
          echo "üîé –ü—Ä–æ–≤–µ—Ä—è—é —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQL —Ñ–∞–π–ª–æ–≤..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–µ –ø—É—Å—Ç—ã–µ –∏ —Å–æ–¥–µ
