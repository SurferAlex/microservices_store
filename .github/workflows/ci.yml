name: CI Pipeline

# –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# –ó–∞–¥–∞—á–∏ (jobs)
jobs:
  # –ó–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  check:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
      
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è auth_service
        working-directory: ./auth_service
        run: |
          echo "üìù –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ auth_service..."
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: gofmt -s -w ."
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è profile_service
        working-directory: ./profile_service
        run: |
          echo "üìù –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ profile_service..."
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "‚ùå –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: gofmt -s -w ."
            gofmt -s -d .
            exit 1
          fi
          echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
      
      - name: üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ auth_service
        working-directory: ./auth_service
        run: |
          echo "üîé –ó–∞–ø—É—Å–∫–∞—é go vet –¥–ª—è auth_service..."
          go vet ./...
          echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–π–¥–µ–Ω!"
      
      - name: üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ profile_service
        working-directory: ./profile_service
        run: |
          echo "üîé –ó–∞–ø—É—Å–∫–∞—é go vet –¥–ª—è profile_service..."
          go vet ./...
          echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–π–¥–µ–Ω!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π auth_service
        working-directory: ./auth_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é go.mod –∏ go.sum –¥–ª—è auth_service..."
          go mod tidy
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå go.mod –∏–ª–∏ go.sum —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: go mod tidy"
            git status
            exit 1
          fi
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π profile_service
        working-directory: ./profile_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é go.mod –∏ go.sum –¥–ª—è profile_service..."
          go mod tidy
          if [ -n "$(git status --porcelain)" ]; then
            echo "‚ùå go.mod –∏–ª–∏ go.sum —Ç—Ä–µ–±—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! –ó–∞–ø—É—Å—Ç–∏—Ç–µ: go mod tidy"
            git status
            exit 1
          fi
          echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ auth_service
        working-directory: ./auth_service
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é auth_service..."
          go mod download
          go build ./cmd/main.go
          echo "‚úÖ auth_service –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ!"
      
      - name: üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ profile_service
        working-directory: ./profile_service
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é profile_service..."
          go mod download
          go build ./cmd/main.go
          echo "‚úÖ profile_service –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ!"
      
      - name: ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        run: |
          echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

  # –ó–∞–¥–∞—á–∞: —Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
  build:
    name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
    runs-on: ubuntu-latest
    needs: check
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
      
      - name: üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üê≥ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: üè∑Ô∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ–≥–æ–≤ –¥–ª—è auth_service
        id: meta-auth
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/auth_service"
          VERSION="${GITHUB_REF#refs/heads/}"
          VERSION="${VERSION#refs/tags/}"
          VERSION="${VERSION:-latest}"
          echo "tags=$IMAGE_NAME:$VERSION,$IMAGE_NAME:latest" >> $GITHUB_OUTPUT
          echo "üì¶ –¢–µ–≥–∏ –¥–ª—è auth_service: $IMAGE_NAME:$VERSION, $IMAGE_NAME:latest"
      
      - name: üè∑Ô∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ–≥–æ–≤ –¥–ª—è profile_service
        id: meta-profile
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/profile_service"
          VERSION="${GITHUB_REF#refs/heads/}"
          VERSION="${VERSION#refs/tags/}"
          VERSION="${VERSION:-latest}"
          echo "tags=$IMAGE_NAME:$VERSION,$IMAGE_NAME:latest" >> $GITHUB_OUTPUT
          echo "üì¶ –¢–µ–≥–∏ –¥–ª—è profile_service: $IMAGE_NAME:$VERSION, $IMAGE_NAME:latest"
      
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ auth_service
        uses: docker/build-push-action@v5
        with:
          context: ./auth_service
          file: ./auth_service/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta-auth.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: üèóÔ∏è –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ profile_service
        uses: docker/build-push-action@v5
        with:
          context: ./profile_service
          file: ./profile_service/Dockerfile
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta-profile.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ‚úÖ –û–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üéâ Docker –æ–±—Ä–∞–∑—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –≤ GitHub Container Registry!"
            echo "üì¶ auth_service: ghcr.io/${{ github.repository_owner }}/auth_service:latest"
            echo "üì¶ profile_service: ghcr.io/${{ github.repository_owner }}/profile_service:latest"
          else
            echo "‚úÖ Docker –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã (–Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –Ω–µ main –≤–µ—Ç–∫–∞)"
          fi

  # –ó–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
  migrations:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞
        uses: actions/checkout@v4
      
      - name: üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ golang-migrate
        run: |
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é golang-migrate..."
          curl -L https://github.com/golang-migrate/migrate/releases/download/v4.17.0/migrate.linux-amd64.tar.gz | tar xvz
          sudo mv migrate /usr/local/bin/migrate
          migrate -version
          echo "‚úÖ golang-migrate —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π auth_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∏–≥—Ä–∞—Ü–∏–π auth_service..."
          cd auth_service/migrations
          for file in *.up.sql; do
            base="${file%.up.sql}"
            if [ ! -f "${base}.down.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ down-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–∞—Ä–∞: ${base}.up.sql –∏ ${base}.down.sql"
          done
          for file in *.down.sql; do
            base="${file%.down.sql}"
            if [ ! -f "${base}.up.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ up-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
          done
          echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ auth_service –∏–º–µ—é—Ç –ø–∞—Ä—ã up/down"
      
      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–π profile_service
        run: |
          echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∏–≥—Ä–∞—Ü–∏–π profile_service..."
          cd profile_service/migrations
          for file in *.up.sql; do
            base="${file%.up.sql}"
            if [ ! -f "${base}.down.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ down-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –ø–∞—Ä–∞: ${base}.up.sql –∏ ${base}.down.sql"
          done
          for file in *.down.sql; do
            base="${file%.down.sql}"
            if [ ! -f "${base}.up.sql" ]; then
              echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ up-–º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è: $file"
              exit 1
            fi
          done
          echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ profile_service –∏–º–µ—é—Ç –ø–∞—Ä—ã up/down"
      
      - name: üîç –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ SQL –º–∏–≥—Ä–∞—Ü–∏–π
        run: |
          echo "üîé –ü—Ä–æ–≤–µ—Ä—è—é —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQL —Ñ–∞–π–ª–æ–≤..."
          find auth_service/migrations profile_service/migrations -name "*.sql" -type f | while read file; do
            if [ ! -s "$file" ]; then
              echo "‚ùå –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏: $file"
              exit 1
            fi
            echo "‚úÖ –§–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π: $file"
          done
          echo "‚úÖ –í—Å–µ SQL —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π –≤–∞–ª–∏–¥–Ω—ã!"
      
      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        run: |
          echo "üéâ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"